version: '3'
services:
  lightwave-server:
    build: server
    hostname: server.${LIGHTWAVE_DOMAIN}
    command: scripts/promote.sh
    volumes:
     - ./server:/scripts
     - ../../../build/rpmbuild/RPMS:/buildrpms
    networks:
     lightwave:
       aliases:
         - server.${LIGHTWAVE_DOMAIN}
       ipv4_address: 172.254.0.2
    dns:
     - 172.254.0.2
     - 172.254.0.3
     - 8.8.8.8
    privileged: true
    environment:
        - LIGHTWAVE_DOMAIN=${LIGHTWAVE_DOMAIN}
        - LIGHTWAVE_PASS=${LIGHTWAVE_PASS}
    tty: true
  lightwave-server-n2:
    build: server
    hostname: server-n2.${LIGHTWAVE_DOMAIN}
    command: scripts/promote.sh
    volumes:
     - ./server:/scripts
     - ../../../build/rpmbuild/RPMS:/buildrpms
    networks:
     lightwave:
       aliases:
         - server-n2.${LIGHTWAVE_DOMAIN}
       ipv4_address: 172.254.0.3
    dns:
     - 172.254.0.2
     - 172.254.0.3
     - 8.8.8.8
    privileged: true
    depends_on:
     - "lightwave-server"
    environment:
        - LIGHTWAVE_DOMAIN=${LIGHTWAVE_DOMAIN}
        - LIGHTWAVE_PASS=${LIGHTWAVE_PASS}
    tty: true
  lightwave-client:
    build: client
    hostname: client.${LIGHTWAVE_DOMAIN}
    command: scripts/join.sh
    volumes:
     - ./client:/scripts
     - ../../../build/rpmbuild/RPMS:/buildrpms
    networks:
     lightwave:
       aliases:
         - client.${LIGHTWAVE_DOMAIN}
    dns:
     - 172.254.0.2
     - 172.254.0.3
     - 8.8.8.8
    depends_on:
     - "lightwave-server-n2"
    environment:
        - LIGHTWAVE_DOMAIN=${LIGHTWAVE_DOMAIN}
        - LIGHTWAVE_PASS=${LIGHTWAVE_PASS}
    tty: true
networks:
  lightwave:
    driver: bridge
#    driver_opts:
#  com.docker.network.enable_ip_masquerade: "false"
    ipam:
      driver: default
      config:
        - subnet: 172.254.0.0/16
