#!/bin/bash

prepare_sts_cert()
{
  CERT_PATH=/etc/vmware/ssl
  mkdir -p $CERT_PATH

  /opt/vmware/bin/vecs-cli entry getkey \
    --store MACHINE_SSL_CERT \
    --alias __MACHINE_CERT \
    --output $CERT_PATH/machine-ssl.key.tmp

  sed '/^\s*$/d' $CERT_PATH/machine-ssl.key.tmp > $CERT_PATH/machine-ssl.key
  chmod 0400 $CERT_PATH/machine-ssl.key
  rm -f $CERT_PATH/machine-ssl.key.tmp

  /opt/vmware/bin/vecs-cli entry getcert \
    --store MACHINE_SSL_CERT \
    --alias __MACHINE_CERT \
    --output $CERT_PATH/machine-ssl.crt

  cert_alias=$(/opt/vmware/bin/vecs-cli entry list --store TRUSTED_ROOTS | \
                                                            grep "Alias" | \
                                                            cut -d: -f2)

  # this only collects trusted cert during install time.
  for cert in $cert_alias
  do
    /opt/vmware/bin/vecs-cli entry getcert \
      --store TRUSTED_ROOTS \
      --alias $cert \
      --output $CERT_PATH/cert.tmp

    echo "trust cert $cert"
    cat $CERT_PATH/cert.tmp >> $CERT_PATH/trusted-ssl.crt

  done

  chown -R lightwave:lightwave /etc/vmware/ssl
  ls -lR /etc/vmware/ssl
  rm -f $CERT_PATH/cert.tmp
}

install_sts()
{
  ADMINUPN="$DEFAULT_DOMAIN_ADMIN@$LIGHTWAVE_DOMAIN"

  /opt/vmware/bin/stssetup install \
    -admin-pwd=$LIGHTWAVE_PASS \
    -admin-uname=$ADMINUPN \
    -cfg-file=$STS_CFG_FILE \
    -dir-certs-file=$STS_DIR_CERTS_FILE \
    -log-file=$STS_LOG_FILE \
    -log-level=4 \
    -port=$STS_PORT \
    -primary \
    -sts-endpoint=$STS_ENDPOINT \
    -site=$DEFAULT_SITE \
    -system-tenant=$DEFAULT_DOMAIN \
    -tls-cert-file=$STS_TLS_CERT_FILE \
    -tls-key-file=$STS_TLS_KEY_FILE \
    -enabled-heads='oidc,rest' \
    -daemon-group=$STS_GROUP \
    -daemon-user=$STS_USER

  if [ $? -ne 0 ]; then
        echo  "Failed to install sts: log file $STS_LOG_FILE ."
	tail -10 $STS_LOG_FILE
        exit 1
  fi

  chown lightwave:lightwave $STS_LOG_FILE
}

# STS Defaults
STS_CFG_FILE=/etc/vmware/stssrv.conf
STS_DIR_CERTS_FILE=/etc/vmware/ssl/trusted-ssl.crt
STS_TLS_CERT_FILE=/etc/vmware/ssl/machine-ssl.crt
STS_TLS_KEY_FILE=/etc/vmware/ssl/machine-ssl.key
STS_LOG_FILE=/var/log/lightwave/stssrv.log
STS_PORT=443
STS_ENDPOINT=`echo $HOSTNAME`:$STS_PORT
STS_SITE=Default-First-Site
STS_GROUP=lightwave
STS_USER=lightwave

DEFAULT_DOMAIN=
DEFAULT_DOMAIN_ADMIN=
DEFAULT_DOMAIN_PASS=
DEFAULT_SITE=Default-First-Site

USAGE="configure-sts --username <user-name>--password <password> --domain <domain-name> --site <site-name>"

# Read passed parameters.
if [ $# -gt 0 ]; then

   MODE="open"

   for arg in "$@"
   do
        case "$MODE" in
            "open")
                case "$arg" in
                    "--domain")
                      MODE="domain"
                      ;;
                    "--password")
                      MODE="password"
                      ;;
                    "--site")
                      MODE="site"
                      ;;
                    "--username")
                      MODE="username"
                      ;;
                    *)
                      echo "Invalid parameter : $arg"
                      echo $USAGE
                      exit 1
                      ;;
                esac
                ;;
             "domain")
                DEFAULT_DOMAIN=$arg
                MODE=open
                ;;
             "password")
                DEFAULT_DOMAIN_PASS=$arg
                MODE=open
                ;;
             "site")
                DEFAULT_SITE=$arg
                MODE=open
                ;;
             "username")
                DEFAULT_DOMAIN_ADMIN=$arg
                MODE=open
                ;;
             *)
                echo "Invalid mode : $MODE"
                echo $USAGE
                exit 1
                ;;
        esac
   done
else
   echo $USAGE
   exit 1
fi

echo "preparing sts certs ..."
prepare_sts_cert

echo "installing sts ..."
install_sts

echo "Secure Token Service was installed Successfully ! "
